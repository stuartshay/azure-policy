name: Deploy Azure Function

on:
  push:
    branches: [ master ]
    paths:
      - 'functions/basic/**'
      - '.github/workflows/deploy-function.yml'
  pull_request:
    branches: [ master ]
    paths:
      - 'functions/basic/**'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: func-azpolicy-dev-001
  AZURE_FUNCTIONAPP_PACKAGE_PATH: './functions/basic'
  PYTHON_VERSION: '3.13'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build and Test Function

    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    - name: Setup Python ${{ env.PYTHON_VERSION }} Environment
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 'Resolve Project Dependencies Using Pip'
      shell: bash
      run: |
        pushd '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
        python -m pip install --upgrade pip
        pip install -r requirements.txt --target=".python_packages/lib/site-packages"
        popd

    - name: 'Run Unit Tests'
      shell: bash
      run: |
        pushd '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
        python -m pip install pytest pytest-cov
        # Install the function requirements for testing
        python -m pip install -r requirements.txt
        python -m pytest tests/ -v --cov=. --cov-report=xml
        popd

    - name: 'Create Function Package'
      shell: bash
      run: |
        pushd '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
        # Remove test files and cache from package
        find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
        find . -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.pyc" -delete 2>/dev/null || true
        find . -name ".coverage" -delete 2>/dev/null || true
        find . -name "coverage.xml" -delete 2>/dev/null || true
        popd

    - name: 'Upload Function Package'
      uses: actions/upload-artifact@v4
      with:
        name: function-package
        path: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    name: Deploy to Azure Function App
    if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'

    steps:
    - name: 'Download Function Package'
      uses: actions/download-artifact@v4
      with:
        name: function-package
        path: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}

    - name: 'Azure Login'
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: 'Deploy to Azure Functions'
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        scm-do-build-during-deployment: false
        enable-oryx-build: false

    - name: 'Verify Deployment'
      shell: bash
      run: |
        echo "Waiting for deployment to complete and verifying deployment..."
        MAX_ATTEMPTS=10
        SLEEP_SECONDS=10
        ATTEMPT=1
        SUCCESS=0

        while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
          echo "Attempt $ATTEMPT: Checking function status..."
          # Try to show the HealthCheck function using Azure CLI
          FUNC_NAME=$(az functionapp function show \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group rg-azpolicy-dev-eastus \
            --function-name HealthCheck \
            --query "name" -o tsv 2>/dev/null)
          if [ "$FUNC_NAME" = "HealthCheck" ]; then
            echo "✅ Function deployment verified successfully"
            SUCCESS=1
            break
          else
            echo "Function not available yet. Waiting $SLEEP_SECONDS seconds before retrying..."
            sleep $SLEEP_SECONDS
            ATTEMPT=$((ATTEMPT+1))
          fi
        done

        if [ $SUCCESS -ne 1 ]; then
          echo "❌ Function deployment verification failed after $MAX_ATTEMPTS attempts."
          exit 1
        fi
  test-deployment:
    runs-on: ubuntu-latest
    needs: deploy
    name: Test Deployed Function
    if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'

    steps:
    - name: 'Azure Login'
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: 'Test Function Endpoints'
      shell: bash
      run: |
        echo "Testing deployed function endpoints..."

        # Get function keys for testing
        FUNCTION_KEY=$(az functionapp keys list \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group rg-azpolicy-dev-eastus \
          --query "functionKeys.default" -o tsv)

        # Test endpoints using function key
        BASE_URL="https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net"

        echo "Testing Hello World endpoint..."
        curl -f -s "$BASE_URL/api/hello?code=$FUNCTION_KEY&name=GitHub" || { echo "Hello endpoint test failed"; exit 1; }

        echo "Testing Health endpoint..."
        curl -f -s "$BASE_URL/api/health?code=$FUNCTION_KEY" || { echo "Health endpoint test failed"; exit 1; }

        echo "Testing Info endpoint..."
        curl -f -s "$BASE_URL/api/info?code=$FUNCTION_KEY" || { echo "Info endpoint test failed"; exit 1; }

        echo "✅ Function endpoint tests completed"
