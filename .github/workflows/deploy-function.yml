name: Deploy Azure Function

on:
  push:
    branches: [ main ]
    paths:
      - 'functions/basic/**'
      - '.github/workflows/deploy-function.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'functions/basic/**'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: func-azpolicy-dev-001
  AZURE_FUNCTIONAPP_PACKAGE_PATH: './functions/basic'
  PYTHON_VERSION: '3.11'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build and Test Function

    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    - name: Setup Python ${{ env.PYTHON_VERSION }} Environment
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 'Resolve Project Dependencies Using Pip'
      shell: bash
      run: |
        pushd '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
        python -m pip install --upgrade pip
        pip install -r requirements.txt --target=".python_packages/lib/site-packages"
        popd

    - name: 'Run Unit Tests'
      shell: bash
      run: |
        pushd '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
        python -m pip install pytest pytest-cov
        python -m pytest tests/ -v --cov=. --cov-report=xml
        popd

    - name: 'Create Function Package'
      shell: bash
      run: |
        pushd '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
        # Remove test files and cache from package
        find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
        find . -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.pyc" -delete 2>/dev/null || true
        find . -name ".coverage" -delete 2>/dev/null || true
        find . -name "coverage.xml" -delete 2>/dev/null || true
        popd

    - name: 'Upload Function Package'
      uses: actions/upload-artifact@v4
      with:
        name: function-package
        path: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    name: Deploy to Azure Function App
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'

    steps:
    - name: 'Download Function Package'
      uses: actions/download-artifact@v4
      with:
        name: function-package
        path: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}

    - name: 'Azure Login'
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: 'Deploy to Azure Functions'
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        scm-do-build-during-deployment: false
        enable-oryx-build: false

    - name: 'Verify Deployment'
      shell: bash
      run: |
        echo "Waiting for deployment to complete..."
        sleep 30

        # Test health endpoint
        HEALTH_URL="https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health"
        echo "Testing health endpoint: $HEALTH_URL"

        # Since the function app has VNet integration and public access disabled,
        # we'll use Azure CLI to test the function
        az functionapp function show \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group rg-azpolicy-dev-eastus \
          --function-name HealthCheck \
          --query "name" -o tsv

        echo "✅ Function deployment verified successfully"

  test-deployment:
    runs-on: ubuntu-latest
    needs: deploy
    name: Test Deployed Function
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'

    steps:
    - name: 'Azure Login'
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: 'Test Function Endpoints'
      shell: bash
      run: |
        echo "Testing deployed function endpoints..."

        # Get function keys for testing
        FUNCTION_KEY=$(az functionapp keys list \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group rg-azpolicy-dev-eastus \
          --query "functionKeys.default" -o tsv)

        # Test endpoints using function key
        BASE_URL="https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net"

        echo "Testing Hello World endpoint..."
        curl -f -s "$BASE_URL/api/hello?code=$FUNCTION_KEY&name=GitHub" || echo "Hello endpoint test failed"

        echo "Testing Health endpoint..."
        curl -f -s "$BASE_URL/api/health?code=$FUNCTION_KEY" || echo "Health endpoint test failed"

        echo "Testing Info endpoint..."
        curl -f -s "$BASE_URL/api/info?code=$FUNCTION_KEY" || echo "Info endpoint test failed"

        echo "✅ Function endpoint tests completed"
